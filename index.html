<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Discord Embeds -->
    <meta content="Pause my music! - Alex ðŸ‘‹" property="og:title" />
    <meta content="Pause my music! Site contains crude words, don't come here if you don't like bad words" property="og:description" />
    <meta content="https://pause.thatalex.dev" property="og:url" />
    <meta content="https://thatalex.dev/static/img/services/spotify-logo.png" property="og:image" />
    <meta content="#000f54" data-react-helmet="true" name="theme-color" />

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <title>Pause! > Alex ðŸ‘‹</title>
</head>
<body>
    <h1>Pause!</h1>
    <p style="font-size:15px;"><a href="https://github.com/awexthedev/pause" target="_blank">Source Code on Github</a></p>
    <p style ="font-size:30px;">Ever wanted to fuck with someones music? Well, now you can fuck with mine!<br>I'm paying for this premium plan, and in turn, this gives me access to premium API routes to control my player.<br>
    This will be harshly rate limited, because I like listening to my music sometimes.</p>

        <hr width="80">

    <div id="content">
        <span style="font-size:50px; text-align:center;" id="contentString"></span>
        <input type="text" style="color:black;" id="messageContent" placeholder="Send a message!"><br>
        <input type="text" style="color:black;" id="uri" placeholder="Add a song to the queue!"><br>
        <button id="button" type="submit" onClick="pausePlayer()">Pause Player</button>
        <span style="font-size:20px;" id="noti"></span>
    </div>

    <hr>
    <h3>How do I get a Spotify URI?</h3>
        <p>URIs are different than Spotify URLs! Please follow the guide below;<br>
        <ul>
            <li>Navigate to a song</li>
            <li>Right click + hover over Share</li>
            <li>Hold CTRL or ALT. You'll see Copy Song URL change to Copy Spotify URI.</li>
            <li>Cash money</li>
        </ul>

        <a href="https://storage.thatalex.dev/screenshots/spotify_bbg0c5vwqu.gif" target="_blank">Gif of the process</a>
    </p>

    <script>
        async function pausePlayer() {

            if (document.cookie) {
                if(!await checkTime(document.cookie.split('; ').find(row => row.startsWith('lastRan=')).split('=')[1])) {
                    return document.getElementById('noti').innerHTML = '<p>You have already paused the player in the last 5 minutes. Please give me time to regain my sanity :)</p>';
                }
            } else {
                if(document.getElementById("messageContent").value) messageSend()
                else return document.getElementById("noti").innerHTML = `<p>At least provide me a message, wtf</p>`

                if(document.getElementById("uri").value) queueSong();
            }

            const epoch = new Date().getTime();
            document.cookie = `lastRan=${epoch}`;

            fetch("https://api.thatalex.dev/v0/web/spotify/pause", {
                method: "get",
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(async function(resp) {
                const response = await resp.json();
                document.getElementById("noti").innerHTML = `<p>${response.message}</p>`;
            });
        }
        
        async function queueSong() {
            const uri = document.getElementById("uri").value;
            if(!uri) return document.getElementById("noti").innerHTML = `<p>Incorrect URI provided; please see below</p>`
            fetch(`https://api.thatalex.dev/v0/web/spotify/change?uri=${uri}`)
            .then(async function(response) {
                const data = await response.json();
                if(response.status == 200) return document.getElementById("noti").innerHTML = `<p>Added song to queue</p>`
                else return document.getElementById("noti").innerHTML = `<p>${data.message}</p>`;
            })
        }
        
        async function checkTime(epoch) {
            console.log(`Running time-since-last-run check..`)
            var cookie = new Date(epoch * 1);
            const currentTime = new Date().getTime();
            var newDateObj = new Date(cookie.getTime() + 5*60000);

            console.log(`Last ran: ${cookie.toLocaleString()}\nExpected end: ${newDateObj.toLocaleString()}`)

            if(newDateObj.getTime() <= currentTime) {
                console.log("Has been longer than the specified time, generating new timestamp..")
                document.cookie = `lastRan=${currentTime}`;
                if (document.getElementById("uri").value) queueSong();
                if(document.getElementById("messageContent").value) messageSend()
                else return document.getElementById("noti").innerHTML = `<p>At least provide me a message, wtf</p>`
                
                return true;
            } else return false;
        }

        async function messageSend() {
            const message = document.getElementById("messageContent").value;
            const data = await fetch(`https://api.thatalex.dev/v0/web/electron/message?content=${message}`, {
                "method": "POST"
            }).then(response => response.json());

            console.log(data);
        }

        const data = fetch("https://api.thatalex.dev/v0/web/spotify/state").then(async function(response) {
            const data = await response.json();
            if(data.status != 401) document.getElementById("contentString").innerHTML = `<p> Currently playing:<br><strong>${data.data.songData.songName}</strong> by <strong>${data.data.songData.artists[0].name}</strong> at <strong>${data.data.device.volume}%</strong> volume.<br>Playing (not paused)? ${data.playing}</p>`;
            else { 
                console.log(`Uh oh! A fucky wucky popped up! >:3`) 
                document.getElementById("contentString").innerHTML = `<p style="color:red; font-size:25px;">${data.message}</p>`; 
                document.getElementById("button").style.display = `none`; 
            }
        });
    </script>
</body>
</html>

<style>
    body {
        background-color: black;
        color:white;
        text-align:center;
    }

    button {
        color:black;
    }

    ul {
        list-style:none;
        text-align:center;
    }
</style>